<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>实时通讯</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
    <style>
        body {
            overflow: hidden;
            padding: 10px;
        }
    </style>
</head>

<body>
    <div class="form-group">
        <label for="username">发送人:</label>
        <select id="sel_user">
            <option value="" selected>请选择</option>
        </select>
    </div>
    <div class="form-group">
        <label for="msgcontent">内容:</label>
        <textarea rows="5" cols="20" id="msgcontent" name="msgcontent" class="form-control"></textarea>
    </div>
    <input type="button" onclick="btnSendMsg()" value="发送">
    <div id="resultHtml">

    </div>

    <script src="../../layui/layui.js"></script>
    <script src="../../js/jquery.min.js"></script>
    <script src="../../js/signalr.js"></script>
    <script src="../../js/main.js"></script>

    <script type="text/javascript">
        var signalr_connection = null;
        $(function () {
            //创建连接对象connection
            signalr_connection = new signalR.HubConnectionBuilder()
                .withUrl(ApiService.SignalRUrl.APIService + "/chatHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            //启动connection
            signalr_connection.start()
                .then(function () {
                    //记录用户登陆
                    signalr_connection.invoke("UserLoginSignalR", GetQueryString('u'))
                        .then(() => {
                            //当有新的用户连接上服务器时,重新获取用户列表
                            signalr_connection.invoke("GetUserList");
                        })
                        .catch(err =>
                            console.error("登陆失败：" + err.toString())
                        );

                }).catch(function (ex) {
                    console.log("连接失败" + ex);
                    //SignalR JavaScript 客户端不会自动重新连接，必须编写代码将手动重新连接你的客户端
                     setTimeout(() => start(), 5000);
                });

            signalr_connection.onclose(async () => {
                start();
            });

            //绑定事件("ReceiveMessage"和服务器端的SendMessage方法中的第一个参数一致)
            signalr_connection.on("ReceiveUserList", function (data) {
                var id = $("#sel_user").val();
                var str = '<option value="" >请选择</option>';
                var list = JSON.parse(data);
                $.each(list, function (i, val) {
                    console.log(val);
                    if (id == val.Value) {
                        str += '<option value="' + val.Value + '" selected>' + val.Key + '</option>';
                    } else {
                        str += '<option value="' + val.Value + '">' + val.Key + '</option>';
                    }
                });
                $("#sel_user").html(str);
            });

            //绑定事件("ReceiveMessage"和服务器端的SendMessage方法中的第一个参数一致)
            signalr_connection.on("ReceiveMessage", function (res) {
                var data = JSON.parse(res);
                $("#resultHtml").append("<h1>" + data.message + "</h1>");
            });
        });


        async function start() {
            try {
                await signalr_connection.start();
                console.log("connected");
            } catch (err) {
                console.log(err);
                setTimeout(() => start(), 5000);
            }
        };


        //发送指定人消息
        function btnSendMsg() {
            var userId = $.trim($("#sel_user").val());
            var msgcontent = $.trim($("#msgcontent").val());
            var msgObj = {};
            msgObj.message = msgcontent;

            signalr_connection.invoke("SendPrivateMessage", userId, JSON.stringify(msgObj))
                .catch(err =>
                    console.error("发送失败：" + err.toString())
                );
        }
    </script>


</body>

</html>